# Docker Compose configuration for Nim development environment
# This file defines the services, networks, and volumes for the Nim dev environment.
#
# Usage:
# - Build and start: docker-compose up -d
# - Stop: docker-compose down
# - Rebuild: docker-compose up -d --build
# - View logs: docker-compose logs -f
#
# The configuration uses volumes to persist data between container restarts.

version: '3.8'

services:
  # Main Nim development service
  nim-dev:
    # Build configuration
    build:
      # Use the Dockerfile in the current directory
      context: .
      dockerfile: Dockerfile
      # Build arguments (can be overridden)
      # Customize installation paths if needed
      args:
        NIMBASE: /opt/nim
        ZIGPATH: /opt/zig
        # Example: Use different paths
        # NIMBASE: /usr/local/nim
        # ZIGPATH: /usr/local/zig

        # Container name for easy reference
    container_name: nim-dev-container

    # Image name after building
    image: nim-dev:latest

    # Keep container running even if no command is specified
    # This is important for dev containers
    stdin_open: true
    tty: true

    # Volume mounts
    # Maps directories between host (Windows) and container (Linux)
    volumes:
      # Mount parent directory to /projects in container for access to sibling projects
      # Current directory (NimBase) is accessible at /projects/NimBase
      # Customize this mount point to fit your workflow:
      #   - For entire D: drive: source: D:\ target: /d
      #   - For user directory: source: ${USERPROFILE} target: /home
      #   - For specific folder: source: D:\MyProjects target: /projects
      - type: bind
        source: ..
        target: /projects

      # Workspace folder points to the NimBase directory inside /projects
      # This is overridden by devcontainer.json workspaceFolder setting

      # Persist Nim packages across container rebuilds
      # This avoids re-downloading packages every time
      - nimble-cache:/root/.nimble

      # Persist Nim compiler cache for faster builds
      - nim-cache:/root/.cache/nim

      # Persist bash history for convenience
      - bash-history:/root/.bash_history_persistent

      # Persist zsh history for convenience
      - zsh-history:/root/.zsh_history_persistent

      # Mount Docker socket for Docker-in-Docker (DinD) support
      # This allows running docker commands inside the container
      # The Docker daemon runs on the host, we just use the CLI
      - /var/run/docker.sock:/var/run/docker.sock

      # Mount SSH keys from Windows host for Git authentication
      # This allows using your existing SSH keys for Git operations
      # Windows path is converted by Docker Desktop
      - ${USERPROFILE}/.ssh:/root/.ssh:ro

      # Mount Git configuration from Windows host
      # Preserves your Git user.name, user.email, and other settings
      - ${USERPROFILE}/.gitconfig:/root/.gitconfig:ro

      # Persist custom zsh configuration across container rebuilds
      # Add your customizations directly in the container at /root/.zshrc.local
      - zsh-config:/root/.zsh_persistent

      # Persist user-level Nim configuration (nim.cfg, config.nims)
      # This allows global Nim settings that apply to all projects
      - nim-user-config:/root/.config/nim

      # Persist npm global packages and cache
      - npm-cache:/root/.npm
      - npm-global:/usr/local/lib/node_modules

      # Persist Bun global packages and cache
      - bun-cache:/root/.bun/install/cache
      - bun-global:/root/.bun/install/global

      # Persist Neovim/Vim configurations
      - nvim-config:/root/.config/nvim
      - vim-config:/root/.vim

      # Persist Git credentials and global ignore
      - git-credentials:/root/.git-credentials
      - git-global-config:/root/.config/git

      # Persist Oh My Posh cache for faster shell startup
      - omp-cache:/root/.cache/oh-my-posh

      # Persist Docker CLI cache and configurations
      - docker-config:/root/.docker

    # Port mappings
    # Format: "host_port:container_port"
    ports:
      # Common development server port
      - "8080:8080"
      # Node.js/React development server port
      - "3000:3000"
      # Additional ports can be added as needed
      # - "5000:5000"

      # Environment variables
    environment:
      # Set timezone
      - TZ=UTC
      # Enable color output in terminal
      - TERM=xterm-256color
      # Git credential helper - uses Windows Credential Manager via host
      - GIT_CONFIG_COUNT=1
      - GIT_CONFIG_KEY_0=credential.helper
      - GIT_CONFIG_VALUE_0=store
      # Custom environment variables for your Nim projects
      # Add any project-specific variables here

      # Network configuration
    networks:
      - nim-network

    # Restart policy
    # "unless-stopped" means container will restart automatically
    # unless explicitly stopped
    restart: unless-stopped

    # Working directory inside container
    working_dir: /workspace

    # Default command (can be overridden)
    # Keeps container running for dev container usage
    command: /bin/bash -c "tail -f /dev/null"

# Named volumes for persistence
# These volumes persist data even when containers are removed
volumes:
  # Nimble package cache
  nimble-cache:
    driver: local
    name: nim-dev-nimble-cache

  # Nim compiler cache
  nim-cache:
    driver: local
    name: nim-dev-nim-cache

  # Bash history
  bash-history:
    driver: local
    name: nim-dev-bash-history

  # Zsh history
  zsh-history:
    driver: local
    name: nim-dev-zsh-history

  # Zsh configuration persistence
  zsh-config:
    driver: local
    name: nim-dev-zsh-config

  # Nim user configuration persistence
  # Stores ~/.config/nim/ for user-level nim.cfg and config.nims
  nim-user-config:
    driver: local
    name: nim-dev-nim-user-config

  # npm cache and global packages
  npm-cache:
    driver: local
    name: nim-dev-npm-cache

  npm-global:
    driver: local
    name: nim-dev-npm-global

  # Bun cache and global packages
  bun-cache:
    driver: local
    name: nim-dev-bun-cache

  bun-global:
    driver: local
    name: nim-dev-bun-global

  # Neovim configuration
  nvim-config:
    driver: local
    name: nim-dev-nvim-config

  # Vim configuration
  vim-config:
    driver: local
    name: nim-dev-vim-config

  # Git credentials storage
  git-credentials:
    driver: local
    name: nim-dev-git-credentials

  # Git global configuration directory
  git-global-config:
    driver: local
    name: nim-dev-git-global-config

  # Oh My Posh cache
  omp-cache:
    driver: local
    name: nim-dev-omp-cache

  # Docker CLI cache and config
  docker-config:
    driver: local
    name: nim-dev-docker-config

# Custom network for the development environment
# Useful if you want to add additional services (databases, etc.)
networks:
  nim-network:
    driver: bridge
    name: nim-dev-network
