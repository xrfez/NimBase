// Dev Container configuration for Nim development environment
// This file configures VS Code's Dev Containers extension to provide
// a complete development environment inside a Docker container.
//
// Prerequisites:
// - Docker Desktop installed on Windows 11
// - VS Code with "Dev Containers" extension installed
//
// Usage:
// 1. Open this folder in VS Code
// 2. Press F1 and select "Dev Containers: Reopen in Container"
// 3. VS Code will build the container and connect to it
{
	// Unique name for this dev container
	"name": "Nim Development Environment",
	// Use docker-compose to build and run the container
	// This allows for more complex setups with volumes and networks
	"dockerComposeFile": "../docker-compose.yml",
	// The service name from docker-compose.yml to use
	"service": "nim-dev",
	// Path to the workspace folder inside the container
	// This should match where NimBase is mounted (parent dir is at /projects)
	"workspaceFolder": "/projects/NimBase",
	// Features to install in the container
	// These are pre-built dev container features from Microsoft
	"features": {
		// Git is essential for version control
		"ghcr.io/devcontainers/features/git:1": {},
		// Common utilities like zsh, oh-my-zsh
		"ghcr.io/devcontainers/features/common-utils:2": {
			"installZsh": true,
			"installOhMyZsh": true,
			"configureZshAsDefaultShell": true,
			"upgradePackages": true
		},
		// Install Nerd Fonts (optional but recommended for best experience)
		// Uncomment if you want Nerd Fonts installed automatically
		// "ghcr.io/meaningful-ooo/devcontainer-features/fish:1": {
		//     "nerdfonts": "FiraCode"
		// }
	},
	// Post-create command to set up Oh My Zsh theme and plugins
	"postCreateCommand": "bash -c 'if [ -d ~/.oh-my-zsh ]; then cp /root/.zshrc_custom ~/.zshrc 2>/dev/null || true; git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions 2>/dev/null || true; git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting 2>/dev/null || true; fi && nim --version'",
	// VS Code settings to apply inside the container
	"customizations": {
		"vscode": {
			// Extensions to install in the container
			"extensions": [
				// Nim language support - official extension from Nim team
				"nimlang.nimlang",
				// Docker support
				"ms-azuretools.vscode-docker",
				// Git integration
				"eamodio.gitlens",
				// Code formatting and linting
				"editorconfig.editorconfig",
				// Better comments
				"aaron-bond.better-comments"
			],
			// VS Code settings for Nim development
			"settings": {
				// Nim-specific settings
				"nim.project": [],
				"nim.projectMapping": [],
				// Disable old nimsuggest in favor of nimlangserver
				"nim.enableNimsuggest": false,
				// Use nimlangserver for LSP (Language Server Protocol)
				"nim.langserver.enable": true,
				"nim.langserver.path": "/root/.nimble/bin/nimlangserver",
				// Disable old nimpretty in favor of nph
				"nim.nimpretty.enable": false,
				// Use NPH (Nim Pretty HTML) for code formatting
				"nim.nph.enable": true,
				"nim.nph.path": "/usr/local/bin/nph",
				"nim.formatter": "nph",
				// Nim file-specific formatting settings
				"[nim]": {
					"editor.defaultFormatter": "nimlang.nimlang",
					"editor.formatOnSave": true
				},
				// Editor settings
				"editor.formatOnSave": true,
				"editor.tabSize": 2,
				"editor.insertSpaces": true,
				"editor.rulers": [
					80,
					100
				],
				// Terminal settings - use zsh by default with Oh My Zsh
				"terminal.integrated.defaultProfile.linux": "zsh",
				"terminal.integrated.profiles.linux": {
					"bash": {
						"path": "/bin/bash",
						"icon": "terminal-bash"
					},
					"zsh": {
						"path": "/bin/zsh",
						"icon": "terminal"
					}
				},
				// Font settings for Nerd Fonts (install on Windows host)
				"terminal.integrated.fontFamily": "MesloLGM Nerd Font, MesloLGS NF, FiraCode Nerd Font, Consolas, monospace",
				"terminal.integrated.fontSize": 14,
				// File associations
				// Note: .nimble files are intentionally NOT associated with "nim" language
				// to prevent nimlangserver from processing them and crashing
				"files.associations": {
					"*.nim": "nim",
					"*.nims": "nim",
					"*.nimble": "ini" // Treat as INI to prevent LSP activation
				},
				// Exclude files from being watched for changes by file watchers
				// This prevents nimlangserver crashes when these files change
				"files.watcherExclude": {
					"**/*.nimble": true,
					"**/*.paths": true,
					"**/*.cfg": true
				},
				// Exclude files from language server processing
				"nim.langserver.excludeFiles": [
					"**/*.nimble",
					"**/*.paths",
					"**/*.cfg"
				]
			}
		}
	},
	// Port forwarding - these ports will be accessible from Windows
	// Format: "containerPort:hostPort" or just "port" for same on both
	"forwardPorts": [
		8080,
		3000
	],
	// Ports to label for easy identification
	"portsAttributes": {
		"8080": {
			"label": "Development Server",
			"onAutoForward": "notify"
		},
		"3000": {
			"label": "Node.js Server",
			"onAutoForward": "notify"
		}
	},
	// Commands to run after the container is created (one-time setup)
	// Fix SSH key permissions if keys are mounted from host
	"postCreateCommand": "bash -c 'if [ -f /root/.ssh/id_ed25519 ]; then chmod 600 /root/.ssh/id_ed25519; fi && if [ -f /root/.ssh/id_ed25519.pub ]; then chmod 644 /root/.ssh/id_ed25519.pub; fi && if [ -f /root/.ssh/id_rsa ]; then chmod 600 /root/.ssh/id_rsa; fi && if [ -f /root/.ssh/id_rsa.pub ]; then chmod 644 /root/.ssh/id_rsa.pub; fi && if [ -d ~/.oh-my-zsh ]; then cp /root/.zshrc_custom ~/.zshrc 2>/dev/null || true; git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions 2>/dev/null || true; git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting 2>/dev/null || true; fi && nim --version'",
	// Commands to run after attaching to the container (every time)
	"postAttachCommand": "echo 'Welcome to Nim Development Environment with Oh My Zsh'",
	// Mount the Docker socket for docker-in-docker scenarios
	// Enables running Docker commands inside the container
	"mounts": [
		"source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind",
		// Mount SSH keys from host for Git authentication (if they exist)
		"source=${localEnv:USERPROFILE}${localEnv:HOME}/.ssh,target=/root/.ssh,readonly,type=bind",
		// Mount Git config from Windows host (if it exists and has proper permissions)
		// If not available, configure Git manually in container: git config --global user.name/email
		"source=${localEnv:USERPROFILE}${localEnv:HOME}/.gitconfig,target=/root/.gitconfig,readonly,type=bind"
	],
	// Set container user (default is root, which is fine for development)
	"remoteUser": "root"
}
